@using Common.Helpers
@model MainSaite.Models.AutoParkViewModel

@{
	ViewBag.Title = "CarEditor";
	string username = (Session["user"] as Model.DTO.UserDTO).UserName;
}
@Styles.Render("~/Content/BootstrapCallout.css")
@Styles.Render("~/Content/bootstrap-datetimepicker.css")
<link rel="stylesheet" href="~/Content/AutoParkCustomStyles.css" type="text/css" />

<div>
	<div class="page-header">
		<h1>@Resources.Resource.Greeting,<small>@username</small></h1>
	</div>
	<div class="panel-group">
		<div id="overpanel" class="panel panel-info">
			<div class="panel-heading">
				<h3 class="panel-title">@Resources.Resource.Garage</h3>
			</div>
			<div class="panel-body">
				<img class="img-thumbnail" src="~/Content/Picture/streets_cars_traffic.jpg" />
			</div>
			<div class="panel-footer">
				<a class="btn btn-success" role="button" onclick="carController.addNewCar()">
					<span class="glyphicon glyphicon-th-list" aria-hidden="true">&nbsp;</span>@Resources.Resource.AddNewCar
				</a>
			</div>
			<div class="table-list">
				<div id="carTableResponsive" class="table-responsive">
					<table class="table table-striped" id="CarParkTable">
						<thead>
							<tr class="info">
								<th>
									@Resources.Resource.ActionsColumn
								</th>
								<th>
									<a id="carlink" href="#" class="btn-link" onclick="carController.sortBy('name')">@Resources.Resource.CarName</a>
								</th>
								<th>
									<a id="carlink" href="#" class="btn-link" onclick="carController.sortBy('nickname')">@Resources.Resource.CarNickName</a>
								</th>
								<th>
									<a id="carlink" href="#" class="btn-link" onclick="carController.sortBy('number')">@Resources.Resource.CarNumber</a>
								</th>
								<th>
									@Resources.Resource.CarState
								</th>
								<th>
									@Resources.Resource.CarStatus
								</th>
							</tr>
						</thead>
						<tbody>
							<script id="carListRow" type="text/x-handlebars-template">
								{{#each cars}}
								<tr>
									<td>
										<!-- Single button -->
										<div class="btn-group">
											<button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
												@Resources.Resource.ActionsColumn <span class="caret"></span>
											</button>
											<ul class="dropdown-menu">
												{{#ifCond OwnerId UserId}}
												<li>
													<a href="#"
													   data-cars-id="{{Id}}"
													   role="button" onclick="carController.getCarEdit(this)">
														<span class="glyphicon glyphicon-cog" aria-hidden="true">&nbsp;</span>@Resources.Resource.editString
													</a>
												</li>
												<li role="separator" class="divider"></li>
												{{/ifCond}}
												{{#ifCond OwnerId UserId}}
												<li>
													<a href="#" data-cars-id="{{Id}}" data-cars-name="{{CarName}}" role="button" onclick="carController.deleteCar(this)">
														<span class="glyphicon glyphicon-trash" aria-hidden="true">&nbsp;</span>@Resources.Resource.deleteString
													</a>
												</li>
												<li role="separator" class="divider"></li>
												{{/ifCond}}
												<li>
													<a href="#"
													   data-cars-id="{{Id}}"
													   role="button" onclick="carController.getCarDetails(this)">
														<span class="glyphicon glyphicon-file" aria-hidden="true">&nbsp;</span>@Resources.Resource.CarsDetails
													</a>
												</li>
												<li role="separator" class="divider"></li>
												{{#ifCond OwnerId UserId}}
												<li>
													<a href="#" data-cars-id="{{Id}}" data-cars-name="{{CarName}}" role="button" onclick="carController.giveCar(this)">
														<span class="glyphicon glyphicon-user" aria-hidden="true">&nbsp;</span>@Resources.Resource.ChangeDriver
													</a>
												</li>
												{{else}}
												<li>
													<a href="#" data-cars-id="{{Id}}" data-cars-name="{{CarName}}" data-cars-owner="{{OwnerId}}" role="button" onclick="carController.returnCar(this)">
														<span class="glyphicon glyphicon-user" aria-hidden="true">&nbsp;</span>@Resources.Resource.Return
													</a>
												</li>
												{{/ifCond}}
											</ul>
										</div>
									</td>
									<td>
										{{CarName}}
									</td>
									<td>
										{{CarNickName}}
									</td>
									<td>
										{{CarNumber}}
									</td>
									<td>
										{{CarStateDescription}}
									</td>
									<td>
										{{#if isMain}}
										<span class="label label-success">@Resources.Resource.CarStatusMain</span>
										{{else}}
										<span class="label label-default"
											  data-cars-id="{{Id}}"
											  data-cars-name="{{CarName}}"
											  role="button" onclick="carController.getThisCarMain(this)">@Resources.Resource.CarStatusSpare</span>
											@*<a class="btn btn-warning" href="#"
												   data-cars-id="{{Id}}"
												   data-cars-name="{{CarName}}"
												   role="button" onclick="carController.getThisCarMain(this)">
													<span class="glyphicon glyphicon-cog" aria-hidden="true">&nbsp;</span>[Change Status]
												</a>*@
											{{/if}}
										</td>
									</tr>
									{{/each}}
								</script>
							</tbody>
						</table>
						@Html.Partial("_DeleteCarPartial", Model.Cars)
						@Html.Partial("_EditCarPartial", Model.Cars)
						@Html.Partial("_AddCarPartial", Model.Cars)
						@Html.Partial("_CarDetails", Model.Cars)
						@Html.Partial("_GiveCarPartial", Model)
						@Html.Partial("_ReturnCarPartial", Model.Cars)
						@Html.Partial("_GetErrorMessage", Model)
						@Html.Partial("_GetMainCarPartial", Model.Cars)
					</div>
				</div>
			</div>
		</div>
	</div>

@section scripts{
	<script src="~/Scripts/moment.js"></script>
	<script src="~/Scripts/bootstrap-datetimepicker.js"></script>
	<script type="text/javascript">
		$(function () {
			$('#datetimepicker1').datetimepicker({
				format: 'L',
				toolbarPlacement: 'top',
				widgetPositioning: {
					horizontal: 'left',
					vertical: 'bottom',
				},
			});
		});
	</script>
	<script type="text/javascript">
		$(function () {
			$('#datetimepicker2').datetimepicker({
				format: 'L',
				toolbarPlacement: 'top',
				widgetPositioning: {
					horizontal: 'left',
					vertical: 'bottom',
				},
			});
		});
	</script>

}
<script type="text/javascript" src="~/Scripts/validator.js"></script>
<script>
	var carParkTemplate = Handlebars.compile($("#carListRow").html());

	var encodedCarData;
	encodedCarData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.Cars.ToList()));

	var userId = @Html.Raw((Session["User"] as Model.DTO.UserDTO).Id);
	var ownerId = @Html.Raw((Session["User"] as Model.DTO.UserDTO).Id);

	var sortCounter;

	var saveRegName = /([A-Z]{0,1}[a-z]{1,10}\s{0,1}){1,2}/;

	var regNickName = /[0-9]{2,4}/;
	var regName = /^[A-Z]{1}[a-z]{1,10}[ ]{0,1}([A-Z]{1}[a-z]{2,10}){0,1}/;
	var regNumber = /[A-Z]{2}\d{4}[A-Z]{2}/;
	var regDate = /^((0?[13578]|10|12)(-|\/)(([1-9])|(0[1-9])|([12])([0-9]?)|(3[01]?))(-|\/)((19)([2-9])(\d{1})|(20)([01])(\d{1})|([8901])(\d{1}))|(0?[2469]|11)(-|\/)(([1-9])|(0[1-9])|([12])([0-9]?)|(3[0]?))(-|\/)((19)([2-9])(\d{1})|(20)([01])(\d{1})|([8901])(\d{1})))$/;

	function checkWithReg(input, regExp){
		var isValueOk = regExp.exec(input.value);
		if (!isValueOk){
			return false;
		}
		else return true;
	}

	function regCheck(input) {
		var OK = regNickName.exec(input.value);
		if (!OK){
			return false;
		}
		else return true;
	}

	function addCarFormValidate() {

		var isCarNameOK = checkWithReg(document.getElementById('inputCarName'), regName);
		var isCarNickOK = checkWithReg(document.getElementById('inputCarNickName'), regNickName);
		var isCarNumOK = checkWithReg(document.getElementById('inputCarNumber'), regNumber);
		var isCarDateOK = checkWithReg(document.getElementById('datetimepicker2'), regDate);
		if (!isCarNickOK || !isCarNameOK || !isCarNumOK || !isCarDateOK) return false;
		var a = $('#add-car-form').validator('validate');
		if (a.valid()){
			carController.addCarConfirm();
		}
		else return false;
	}

	function editCarFormValidate() {

		var isNewNameOK = checkWithReg(document.getElementById('newInputCarName'), regName);
		var isNewNickOK = checkWithReg(document.getElementById('newInputCarNickName'), regNickName);
		var isNewNumOK = checkWithReg(document.getElementById('newInputCarNumber'), regNumber);
		var isNewDateOK = checkWithReg(document.getElementById('datetimepicker1'), regDate);
		if (!isNewNickOK || !isNewNameOK || !isNewNumOK || !isNewDateOK) return false;
		var b = $('#edit-car-form').validator('validate');
		if (b.valid()){
			carController.editCarConfirm();
		}
		else return false;
	}
	
</script>
<script type="text/javascript" src="~/Scripts/AutoParkScripts.js"></script>
<script type="text/javascript" src="~/Scripts/HandlebarsCustomHelpers.js"></script>