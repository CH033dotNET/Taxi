@model Model.DTO.OrderExDTO
@{
	Layout = null;
}

@if(Model!=null) {
<form role="form" id="form">
	@if (Model.UserId != null) {  
	<input type="hidden" id="userId" value=@Model.UserId>	
	}														  
	@if (Model.AdditionallyRequirements != null) { 
	<div class="form-group">
		<div class="form-group-header">
			<div class="label-underline underline-gray">
				<label class="label-title">@Resources.Resource.Additional</label>
			</div>
			<div class="align-right">
				<span id="show"></span>
				<span id="hide"></span>
			</div>
		</div>
		<div class="form-group-body" id="additional">
			<div class="row">
				<label class="col-sm-3 form-control-label">@Resources.Resource.WhenToGo</label>
				<div class="col-sm-9 radio-box form-inline">
					<label class="radio-inline"><input type="radio" id="urgently" name="urgency" checked="@Model.AdditionallyRequirements.Urgently"><span></span>@Resources.Resource.Urgently</label>
					<label class="radio-inline"><input type="radio" id="pre-order" name="urgency" checked="@(!Model.AdditionallyRequirements.Urgently)"><span></span>@Resources.Resource.PreOrder</label>
					<div class="input-group bootstrap-datetimepicker datetimepicker" id="time-group">
						<input type="text" id="time" class="form-control" />
						<span class="input-group-addon">
							<span class="glyphicon icon-time"></span>
						</span>
					</div>
				</div>
			</div>
			<div class="row">
				<label class="col-sm-3 form-control-label">@Resources.Resource.ClassOfCar</label>
				<div class="col-sm-9 button-box">
					<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.Normal"><input type="radio" id="normal" name="car-class" checked="@(Model.AdditionallyRequirements.Car == Common.Enum.CarEnums.CarClassEnum.Normal)"><span></span></label>
					<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.Universal"><input type="radio" id="universal" name="car-class" checked="@(Model.AdditionallyRequirements.Car == Common.Enum.CarEnums.CarClassEnum.Universal)"><span></span></label>
					<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.Minivan"><input type="radio" id="minivan" name="car-class" checked="@(Model.AdditionallyRequirements.Car == Common.Enum.CarEnums.CarClassEnum.Minivan)"><span></span></label>
					<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.Lux"><input type="radio" id="lux" name="car-class" checked="@(Model.AdditionallyRequirements.Car == Common.Enum.CarEnums.CarClassEnum.Lux)"><span></span></label>
				</div>
			</div>
			<div class="row">
				<label class="col-sm-3 form-control-label">@Resources.Resource.Additionally</label>
				<div class="col-sm-8 button-box">
					<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.Courier"><input type="checkbox" id="courier" checked="@(Model.AdditionallyRequirements.Courier)"><span></span></label>
					<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.WithPlate"><input type="checkbox" id="with-plate" checked="@(Model.AdditionallyRequirements.WithPlate)"><span></span></label>
					<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.MyCar"><input type="checkbox" id="my-car" checked="@(Model.AdditionallyRequirements.MyCar)"><span></span></label>
					<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.WithPets"><input type="checkbox" id="pets" checked="@(Model.AdditionallyRequirements.Pets)"><span></span></label>
					<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.WithBaggage"><input type="checkbox" id="bag" checked="@(Model.AdditionallyRequirements.Bag)"><span></span></label>
					<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.Conditioner"><input type="checkbox" id="conditioner" checked="@(Model.AdditionallyRequirements.Conditioner)"><span></span></label>
					<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.WithEnglish"><input type="checkbox" id="english" checked="@(Model.AdditionallyRequirements.English)"><span></span></label>
					<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.NoSmoking"><input type="checkbox" id="nosmoking" checked="@(Model.AdditionallyRequirements.NoSmoking)"><span></span></label>
					<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.Smoking"><input type="checkbox" id="smoking" checked="@(Model.AdditionallyRequirements.Smoking)"><span></span></label>
					<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.WithCheck"><input type="checkbox" id="check" checked="@(Model.AdditionallyRequirements.Check)"><span></span></label>
				</div>
			</div>
		</div>
	</div>
	}
	<div id="cost-group">
		<label>@Resources.Resource.Price: </label>
		<div id="cost">@Model.Price</div>
	</div>
</form>

<table id="startRideDiv">
	<tr>
		<td>
			<select id="sTariff"></select>
		</td>
		<td>
			<button type="button" id="btnStart" class="btn btn-success btn-lg" onclick="StartOrder()">@Resources.Resource.Start</button>
			<button type="button" id="btnStop" class="btn btn-success warning btn-lg" onclick="StopOrder()" style="display:none;">@Resources.Resource.Stop</button>
		</td>
	</tr>
	<tr>
		<td colspan="2" style="text-align: center;">
			
			<div class="checkbox">
             @if (Model.UserId != null) {
				<label><input type="checkbox" id="clientBonus" value="">[USER WANT TO USE BONUSES]</label>}
			 else
			 {
				<label>[THIS CLIENT IS UNREGISTERED]</label>
			 }																				  
			</div>

		</td>
	</tr>
</table>
}
<script>
	var tariffs;
	var calculatorIntervalId;
	var prevLatitude = null;
	var prevLongitude = null;
	var distancePrice = 0;
	var finalPrice = 0;
	var PERIOD = 5000;

	$(document).ready(function () {
		$.ajax({
			type: "POST",
			url: "/TariffEx/GetAllActiveTariffs"
		}).done(function (data) {
			tariffs = data;
			for (var i in data) {
				$('#sTariff').append('<option value="' + i + '">' + data[i].Name + '</option>');
			}
		});
	});

	function StartOrder() {
		$('#btnStart').hide();
		$('#btnStop').show();

		var prevLatitude = null;
		var prevLongitude = null;
		var distancePrice = 0;

		calculatorIntervalId = setInterval(CalculatePrice, PERIOD);
	}

	function StopOrder() {

		$('#btnStart').show();
		$('#btnStop').hide();
		clearInterval(calculatorIntervalId);
		distancePrice = 0;
		//logic for bonuses

		userId = $('#userId').val();

		if (userId !== undefined) {
			$.ajax({
				type: "POST",
				url: "/Client/SetClientBonus",
				dataType: "json",
				data: {userID :userId, Bonus: finalPrice*0.05},
				success: function (data) {
					//add ability to use bonuses
					//and eneble partial view
				},
				error: function (error) {
					alert(error.statusText);
				}
			});
		}
		if ($('#clientBonus').is(":checked") && userId===undefined) {
			


		}
		finalPrice = 0;
	}

	function CalculatePrice() {
		var selectedTariffIndex = $('#sTariff').val();
		var startPrice = 0;

		// Courier
		if (document.getElementById('courier').checked) startPrice += tariffs[selectedTariffIndex].PriceCourierOption;

		// Plate
		if (document.getElementById('with-plate').checked) startPrice += tariffs[selectedTariffIndex].PricePlateOption;

		// ClientCar
		if (document.getElementById('my-car').checked) startPrice += tariffs[selectedTariffIndex].PriceClientCarOption;

		//SpeakEnglish
		if (document.getElementById('english').checked) startPrice += tariffs[selectedTariffIndex].PriceSpeakEnglishOption;

		//PassengerSmoker
		if (document.getElementById('smoking').checked) startPrice += tariffs[selectedTariffIndex].PricePassengerSmokerOption;

		// Pre Order
		if (document.getElementById('pre-order').checked) startPrice += tariffs[selectedTariffIndex].PricePreOrder;

		// Regular Car
		if (document.getElementById('normal').checked) startPrice += tariffs[selectedTariffIndex].PriceRegularCar;

		// Universal Car
		if (document.getElementById('universal').checked) startPrice += tariffs[selectedTariffIndex].PriceRegularCar;

		// Minivan Car
		if (document.getElementById('minivan').checked) startPrice += tariffs[selectedTariffIndex].PriceMinivanCar;

		// Lux Car
		if (document.getElementById('lux').checked) startPrice += tariffs[selectedTariffIndex].PriceLuxCar;

		navigator.geolocation.getCurrentPosition(function (position) {
			if (prevLatitude != null && prevLongitude != null) {
				var x1 = prevLatitude;
				var x2 = position.coords.latitude;
				var y1 = prevLongitude;
				var y2 = position.coords.longitude;
				var distance = Math.sqrt((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));

				if (distance != 0) {
					distancePrice += distance * tariffs[selectedTariffIndex].PriceInCity * PERIOD / 60000;
				}
			}

			prevLatitude = position.coords.latitude;
			prevLongitude = position.coords.longitude;
		});
		finalPrice = (startPrice + distancePrice).toFixed(2);
		$('#cost').html(finalPrice);
	}
</script>
<script src="~/Scripts/moment.js"></script>
<script src="~/Scripts/bootstrap-datetimepicker.js"></script>
<script src="~/Scripts/OrderForm.js"></script>
<link href="~/Content/OrderForm.css" rel=stylesheet type="text/css">