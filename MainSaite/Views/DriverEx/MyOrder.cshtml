@model Model.DTO.OrderExDTO
@{
	Layout = null;
}

@if (Model != null)
{
	<form role="form" id="form">

		<input type="hidden" id="orderId" value=@Model.Id>

		@if (Model.UserId != null)
		{
			<input type="hidden" id="userId" value=@Model.UserId>
		}
		<div class="row">
			<div class="col-md-2"></div>
			<div class="col-md-8" style="text-align:center">
				<h2 style="font-size: 18px;margin: 0px;">
					@Resources.Resource.Address
			</h2>
				<h2>@Model.FullAddressFrom</h2>
			</div>
			<div class="col-md-2"></div>
		</div>
		<div class="form-group">
			<div class="form-group-header">
				<div class="label-underline underline-gray">
					<label class="label-title">@Resources.Resource.Additional</label>
				</div>
				<div class="align-right">
					<span id="show"></span>
					<span id="hide"></span>
				</div>
			</div>
			<div class="form-group-body" id="additional">
				<div class="row">
					<label class="col-sm-3 form-control-label">@Resources.Resource.WhenToGo</label>
					<div class="col-sm-9 radio-box form-inline">
						<label class="radio-inline"><input type="radio" id="urgently" name="urgency" checked="@Model.AdditionallyRequirements.Urgently"><span></span>@Resources.Resource.Urgently</label>
						<label class="radio-inline"><input type="radio" id="pre-order" name="urgency" checked="@(!Model.AdditionallyRequirements.Urgently)"><span></span>@Resources.Resource.PreOrder</label>
						<div class="input-group bootstrap-datetimepicker datetimepicker" id="time-group">
							<input type="text" id="time" class="form-control" />
							<span class="input-group-addon">
								<span class="glyphicon icon-time"></span>
							</span>
						</div>
					</div>
				</div>
				<div class="row">
					<label class="col-sm-3 form-control-label">@Resources.Resource.ClassOfCar</label>
					<div class="col-sm-9 button-box">
						<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.Normal"><input type="radio" id="normal" name="car-class" checked="@(Model.AdditionallyRequirements.Car == Common.Enum.CarEnums.CarClassEnum.Normal)"><span></span></label>
						<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.Universal"><input type="radio" id="universal" name="car-class" checked="@(Model.AdditionallyRequirements.Car == Common.Enum.CarEnums.CarClassEnum.Universal)"><span></span></label>
						<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.Minivan"><input type="radio" id="minivan" name="car-class" checked="@(Model.AdditionallyRequirements.Car == Common.Enum.CarEnums.CarClassEnum.Minivan)"><span></span></label>
						<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.Lux"><input type="radio" id="lux" name="car-class" checked="@(Model.AdditionallyRequirements.Car == Common.Enum.CarEnums.CarClassEnum.Lux)"><span></span></label>
					</div>
				</div>
				<div class="row">
					<label class="col-sm-3 form-control-label">@Resources.Resource.Additionally</label>
					<div class="col-sm-8 button-box">
						<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.Courier"><input type="checkbox" id="courier" checked="@(Model.AdditionallyRequirements.Courier)"><span></span></label>
						<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.WithPlate"><input type="checkbox" id="with-plate" checked="@(Model.AdditionallyRequirements.WithPlate)"><span></span></label>
						<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.MyCar"><input type="checkbox" id="my-car" checked="@(Model.AdditionallyRequirements.MyCar)"><span></span></label>
						<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.WithPets"><input type="checkbox" id="pets" checked="@(Model.AdditionallyRequirements.Pets)"><span></span></label>
						<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.WithBaggage"><input type="checkbox" id="bag" checked="@(Model.AdditionallyRequirements.Bag)"><span></span></label>
						<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.Conditioner"><input type="checkbox" id="conditioner" checked="@(Model.AdditionallyRequirements.Conditioner)"><span></span></label>
						<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.WithEnglish"><input type="checkbox" id="english" checked="@(Model.AdditionallyRequirements.English)"><span></span></label>
						<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.NoSmoking"><input type="checkbox" id="nosmoking" checked="@(Model.AdditionallyRequirements.NoSmoking)"><span></span></label>
						<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.Smoking"><input type="checkbox" id="smoking" checked="@(Model.AdditionallyRequirements.Smoking)"><span></span></label>
						<label class="button-inline" data-toggle="tooltip" title="@Resources.Resource.WithCheck"><input type="checkbox" id="check" checked="@(Model.AdditionallyRequirements.Check)"><span></span></label>
					</div>
				</div>
			</div>
		</div>
		<div id="cost-group">
			<label>@Resources.Resource.Price: </label>
			<div id="cost">@Model.Price</div>
		</div>
	</form>

	<table id="startRideDiv">
		<tr>
			<td>
				<select id="sTariff"></select>
			</td>
			<td>
				<button type="button" id="btnStart" class="btn btn-success btn-lg" onclick="StartOrder()">@Resources.Resource.Start</button>
				<button type="button" id="btnStop" class="btn btn-success warning btn-lg" onclick="StopOrder()" style="display:none;">@Resources.Resource.Stop</button>
			</td>
		</tr>
	</table>
	<div id="myModal" class="modal fade" role="dialog">
		<div class="modal-dialog">

			<div class="modal-content">
				<div class="modal-header modal-header-info" id="modalHeader">
					@*<button type="button" class="close" data-dismiss="modal">&times;</button>*@
					<h4 class="modal-title">[ORDER PAYMENT]</h4>
				</div>
				<div class="modal-body" id="modalBody">
					<div class="btform">
						<div id="ModalContent">
							<table class="table" id="EditOrderTable">
								<caption>[TRIP INFO]</caption>
								<tr>
									<td>
										@Html.Label(Resources.Resource.Price)
									</td>
									<td>
										<label id="FinalPrice"></label>
									</td>
								</tr>
							</table>
							<table class="table" id="EditOrderTable">
								<caption>[BONUSES]</caption>
								<tr>
									<td>
										@Html.Label("[Bonus]")
									</td>
									<td>
										@if (Model.UserId != null)
											{
										<div class="checkbox">
											<label><input type="checkbox" id="clientBonus" value="">[USE CLIENT BONUSES]</label>
										</div>
										}
										else
										{
												<label>[THIS CLIENT IS UNREGISTERED]</label>
										}
									</td>
								</tr>
							</table>
							<table class="table" id="EditOrderTable">
								<caption>[FINAL BILL]</caption>
								<tr>
									<td colspan="2" id="finalBill">
										@Html.Label("[FINAL PRICE:]")
										<div id="loading">
											<i class="fa fa-refresh fa-spin fa-5x"></i>
										</div>
										<div>
											<label id="BonusPrice"></label>
										</div>
									</td>
								</tr>
							</table>

						</div>
						<input type="submit" id="mdal-submit" class="btn btn-success" name="Ok" value="[Bill is paid]" />
					</div>
				</div>
				@*<div class="modal-footer" id="modalFooter">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>*@
			</div>
		</div>
	</div>
}
else
{
	<p>[NO CURRENT ORDER]</p>
}
<script>
	var tariffs;
	var calculatorIntervalId;
	var prevLatitude = null;
	var prevLongitude = null;
	var distancePrice = 0;
	var finalPrice = 0;
	var PERIOD = 5000;
	var priceWithBonus = 0;
	var paidByBonus = 0;
	$(document).ready(function () {
		$.ajax({
			type: "POST",
			url: "/TariffEx/GetAllActiveTariffs"
		}).done(function (data) {
			tariffs = data;
			for (var i in data) {
				$('#sTariff').append('<option value="' + i + '">' + data[i].Name + '</option>');
			}
		});

		$("#clientBonus").change(function () {
			if (this.checked) {             
				$('#BonusPrice').hide();
				$('#loading').show();

				var userId = $('#userId').val();
			
				$.ajax({
					type: "POST",
					url: "./Client/UseClientBonus",
					dataType: "json",
					data: { userID: userId, Price: finalPrice},
					success: function (data) {
						data = data.toFixed(1);
						$('#loading').hide();
						$('#BonusPrice').show();
						$('#BonusPrice').text(data + ' UAH');
						priceWithBonus = data;
						paidByBonus = (data == 0) ? finalPrice : (finalPrice - data);
					},
					error: function (error) {
						alert(error.statusText);
					}
				});

			}
			else {
				priceWithBonus = 0;
				paidByBonus = 0;
				$('#BonusPrice').show();
				$('#BonusPrice').text(finalPrice + ' UAH');
				$('#loading').hide();
			}
		});

		$(document).on('click', '#mdal-submit', function () {

			if (priceWithBonus != 0) finalPrice = priceWithBonus;
			else finalPrice = 0;

			var userId = $('#userId').val();

			var orderId = $('#orderId').val();

			$.ajax({
				type: "POST",
				url: "./OrderEx/FinishOrder",
				dataType: "json",
				data: { Id: orderId },
				success: function (data) {
					if (userId !== undefined) {
						$.ajax({
							type: "POST",
							url: "./Client/SetClientBonus",
							dataType: "json",
							data: { userID: userId, Bonus: (finalPrice * 0.05), PaidByBonus: paidByBonus },
							success: function (data) {
								finalPrice = 0;
								priceWithBonus = 0;
							},
							error: function (error) {
								alert(error.statusText);
							}
						});
					}

					$('#myModal').modal('hide');

				},
				error: function (error) {
					alert(error.statusText);
				}
			});

		});

		$("#myModal").on('hidden.bs.modal', function () {
			location.reload();
		});
	});

	function StartOrder() {
		$('#btnStart').hide();
		$('#btnStop').show();

		var prevLatitude = null;
		var prevLongitude = null;
		var distancePrice = 0;

		calculatorIntervalId = setInterval(CalculatePrice, PERIOD);
	}

	function StopOrder() {

		$('#btnStart').show();
		$('#btnStop').hide();
		clearInterval(calculatorIntervalId);
		distancePrice = 0;

		$("#myModal").modal();

		$("#FinalPrice").text(finalPrice + ' UAH');
		$("#BonusPrice").text(finalPrice + ' UAH');

		//logic for bonuses
	}

	function CalculatePrice() {
		var selectedTariffIndex = $('#sTariff').val();
		var startPrice = 0;

		// Courier
		if (document.getElementById('courier').checked) startPrice += tariffs[selectedTariffIndex].PriceCourierOption;

		// Plate
		if (document.getElementById('with-plate').checked) startPrice += tariffs[selectedTariffIndex].PricePlateOption;

		// ClientCar
		if (document.getElementById('my-car').checked) startPrice += tariffs[selectedTariffIndex].PriceClientCarOption;

		//SpeakEnglish
		if (document.getElementById('english').checked) startPrice += tariffs[selectedTariffIndex].PriceSpeakEnglishOption;

		//PassengerSmoker
		if (document.getElementById('smoking').checked) startPrice += tariffs[selectedTariffIndex].PricePassengerSmokerOption;

		// Pre Order
		if (document.getElementById('pre-order').checked) startPrice += tariffs[selectedTariffIndex].PricePreOrder;

		// Regular Car
		if (document.getElementById('normal').checked) startPrice += tariffs[selectedTariffIndex].PriceRegularCar;

		// Universal Car
		if (document.getElementById('universal').checked) startPrice += tariffs[selectedTariffIndex].PriceRegularCar;

		// Minivan Car
		if (document.getElementById('minivan').checked) startPrice += tariffs[selectedTariffIndex].PriceMinivanCar;

		// Lux Car
		if (document.getElementById('lux').checked) startPrice += tariffs[selectedTariffIndex].PriceLuxCar;

		navigator.geolocation.getCurrentPosition(function (position) {
			if (prevLatitude != null && prevLongitude != null) {
				var x1 = prevLatitude;
				var x2 = position.coords.latitude;
				var y1 = prevLongitude;
				var y2 = position.coords.longitude;
				var distance = Math.sqrt((x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2));

				if (distance != 0) {
					distancePrice += distance * tariffs[selectedTariffIndex].PriceInCity * PERIOD / 60000;
				}
			}

			prevLatitude = position.coords.latitude;
			prevLongitude = position.coords.longitude;
		});
		finalPrice = (startPrice + distancePrice).toFixed(2);
		$('#cost').html(finalPrice);
	}
</script>
<script src="~/Scripts/moment.js"></script>
<script src="~/Scripts/bootstrap-datetimepicker.js"></script>
<script src="~/Scripts/OrderForm.js"></script>
<link href="~/Content/OrderForm.css" rel=stylesheet type="text/css">